# 31 December, 2015

## ajax level2 progress

### xhr.onprogress
这个事件用于下载，即服务端传回数据时监听。`xhr.onprogress(event)`有一个`event.lengthComputable`属性，为`true`表示文件总大小`event.total`已经计算好了，可以使用，这个值是读的`response header`中的`Content-Length`，所以**服务端的header中必须传回`Content-Length`，值为下载的文件大小，不然`lengthComputable`会一直为`false`

```js
var xhr = new XMLHttpRequest();
    
    xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
            if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 304) {
                console.log(xhr.responseText);
            }
            else {
                console.log(xhr.status);
            }
        }
    }
    
    xhr.onprogress = function (ev) {
        if (ev.lengthComputable) {
            $process.textContent = Math.round(ev.loaded / ev.total) * 100 + '%';
        }
    }
    
    xhr.open('get', '/download', true);
    xhr.send(null);
```

### xhr.upload.onprogress
该事件用于上传文件，跟`xhr.onprogress`差不多。

```js
var xhr = new XMLHttpRequest();
xhr.overrideMimeType('text/html');
    
xhr.onreadystatechange = () => {
    if (xhr.readyState === 4) {
        if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 304) {
            console.log(xhr.responseText);
        }
        else {
            console.log(xhr.status);
        }
    }
}
    
xhr.upload.onprogress = function (ev) {
    if (ev.lengthComputable) {
        $process.textContent = Math.round(ev.loaded / ev.total) * 100 + '%';
    }
}
    
xhr.open('post', '/upload', true);
xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    
xhr.send(formData);
```
